trigger:
  branches:
    include:
      - release/shopping/v*
      - refs/release/shopping/v*

pool:
  vmImage: "ubuntu-latest"

variables:
  azureServiceConnection: "azure-rm-andaha-dev-connection"
  containerRegistryConnection: "andaha-container-reg-connection"
  imageTag: "$(Build.SourceBranchName)"
  bicepTemplateFile: "bicep/deploy/main-shopping.bicep"

stages:
- stage: CI
  displayName: CI
  jobs:
    - job: build_and_push_image
      steps:
      - task: Docker@2
        displayName: build image
        inputs:
          command: build
          arguments: '--build-arg PatPlaceholder=$(NugetFeedAccessToken)'
          dockerfile: src/Services/Andaha.Services.Shopping/Dockerfile
          repository: andaha/services/shopping
          containerRegistry: $(containerRegistryConnection)
          tags: $(imageTag)
          
      - task: Docker@2
        displayName: push image
        inputs:
          command: push
          dockerfile: src/Services/Andaha.Services.Shopping/Dockerfile
          repository: andaha/services/shopping
          containerRegistry: $(containerRegistryConnection)
          tags: $(imageTag)

      - task: CopyFiles@2
        displayName: "copy bicep files to staging directory"
        inputs:
          sourceFolder: src/Services/Andaha.Services.Shopping/Pipeline/deploy
          targetFolder: "$(Build.ArtifactStagingDirectory)/"

      - task: PublishBuildArtifacts@1
        displayName: "Publish Artifact"

- stage: CD
  displayName: CD
  dependsOn: CI
  jobs:
  - job: deployment
    steps:
    - task: DownloadPipelineArtifact@2
      displayName: 'Downloading artifact'
      inputs:
        buildType: 'current'
        artifact: drop
        targetPath: '$(System.ArtifactsDirectory)'

    - task: AzureCLI@2
      displayName: 'Deploy to dev'
      inputs:
        azureSubscription: $(azureServiceConnection)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az deployment group create --resource-group andaha-dev --template-file $(bicepTemplateFile)   